---
import type { Airfoil } from '../../types';

interface Props {
  airfoil: Airfoil;
}

const { airfoil } = Astro.props;
---

<div 
  class="airfoil-card bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-shadow duration-200" 
  data-id={airfoil.id} 
  data-name={airfoil.name} 
  data-description={airfoil.description || ''}
>
  <div class="p-4">
    <div class="flex justify-between items-start">
      <div>
        <h3 class="text-lg font-medium text-gray-900">{airfoil.name}</h3>
        <p class="text-sm text-gray-600">{airfoil.description || 'No description available'}</p>
      </div>
      <button 
        class="favorite-btn text-gray-400 hover:text-red-500 focus:outline-none rounded-full p-1" 
        data-id={airfoil.id}
        aria-label={`Add ${airfoil.name} to favorites`}
        style="box-shadow: none; border: none;"
      >
        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41 0.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
        </svg>
      </button>
    </div>
    
    <div class="mt-3 border-b border-gray-200 pb-3">
      <canvas 
        class="airfoil-canvas w-full h-16" 
        data-coords={JSON.stringify(airfoil.coordinates)}
        aria-label={`Airfoil shape visualization for ${airfoil.name}`}
      ></canvas>
    </div>
    
    <div class="mt-3 grid grid-cols-2 gap-2">
      <div>
        <h4 class="text-xs font-medium text-gray-500 uppercase">Quick Stats</h4>
        <div class="grid grid-cols-2 gap-1 mt-1">
          <div class="text-sm text-gray-700">Camber</div>
          <div class="text-sm text-gray-900 font-medium">{airfoil.camber || '--'}</div>
          <div class="text-sm text-gray-700">Thickness</div>
          <div class="text-sm text-gray-900 font-medium">{airfoil.thickness || '--'}</div>
          <div class="text-sm text-gray-700">Re Range</div>
          <div class="text-sm text-gray-900 font-medium">{airfoil.reynoldsRange || '--'}</div>
        </div>
      </div>
      <div>
        <h4 class="text-xs font-medium text-gray-500 uppercase">Performance</h4>
        <div class="grid grid-cols-2 gap-1 mt-1">
          <div class="text-sm text-gray-700">Max Cl/Cd</div>
          <div class="text-sm text-gray-900 font-medium">{airfoil.maxLiftDragRatio || '--'}</div>
          <div class="text-sm text-gray-700">Stall Angle</div>
          <div class="text-sm text-gray-900 font-medium">{airfoil.stallAngle || '--'}</div>
          <div class="text-sm text-gray-700">Cm</div>
          <div class="text-sm text-gray-900 font-medium">{airfoil.momentCoefficient || '--'}</div>
        </div>
      </div>
    </div>
    
    <div class="mt-3 flex space-x-2">
      <button 
        class="compare-btn flex-1 bg-gray-100 text-gray-700 py-2 px-3 rounded text-sm font-medium flex justify-center items-center hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-gray-500" 
        data-id={airfoil.id} 
        data-name={airfoil.name}
        aria-label={`Add ${airfoil.name} to comparison`}
      >
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
        </svg>
        Compare
      </button>
      <a 
        href={`/airfoil/${airfoil.id}`} 
        class="flex-1 bg-blue-600 text-white py-2 px-3 rounded text-sm font-medium flex justify-center items-center hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
        aria-label={`View details for ${airfoil.name}`}
      >
        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Details
      </a>
    </div>
  </div>
  <div class="bg-blue-50 px-4 py-2 text-xs text-blue-800">
    {airfoil.applications ? airfoil.applications.join(', ') : 'General purpose'}
  </div>
</div>

<script>
function waitForStorage(callback) {
  if (window.storage) {
    callback();
  } else {
    setTimeout(() => waitForStorage(callback), 50);
  }
}

function updateFavoriteIcon(btn, isFav) {
  const svg = btn.querySelector('svg');
  if (svg) {
    svg.setAttribute('fill', isFav ? 'red' : 'none');
    btn.classList.toggle('text-red-500', isFav);
    btn.classList.toggle('text-gray-400', !isFav);
  }
}

function updateFavoritesSidebar() {
  const favorites = window.storage.get('favorites');
  const favoritesList = document.getElementById('favorites');
  if (favoritesList) {
    favoritesList.innerHTML = '';
    if (favorites.length === 0) {
      favoritesList.innerHTML = '<li class="pl-2 text-gray-700">No favorites yet.</li>';
    } else {
      favorites.forEach(airfoil => {
        favoritesList.innerHTML += `<li class='pl-2 text-gray-700'>${airfoil.name}</li>`;
      });
    }
  }
}

// Initialize favorite buttons
document.addEventListener('DOMContentLoaded', () => {
  waitForStorage(() => {
    document.querySelectorAll('.favorite-btn').forEach(btn => {
      const id = btn.getAttribute('data-id');
      const isFav = window.storage.isFavorite(id);
      updateFavoriteIcon(btn, isFav);
      
      btn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        const card = btn.closest('.airfoil-card');
        const name = card?.getAttribute('data-name') || '';
        const description = card?.getAttribute('data-description') || '';
        const airfoil = { id, name, description };
        const newFav = window.storage.toggleFavorite(airfoil);
        updateFavoriteIcon(btn, newFav);
        updateFavoritesSidebar();
      });
    });
    
    updateFavoritesSidebar();
  });
});
</script> 